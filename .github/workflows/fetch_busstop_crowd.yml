# .github/workflows/fetch-seoul-bus-crowd.yml
name: Fetch Seoul V2X Bus Station Crowd JSON

on:
  schedule:
    - cron: "*/5 * * * *" # 5분마다 (UTC)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: fetch-seoul-bus-crowd
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      CAMERA_ID: "DLD1120013000" # ← 원하는 cameraId로 변경
    steps:
      - uses: actions/checkout@v4

      - name: Fetch & filter by cameraId, then save
        env:
          API_KEY: ${{ secrets.SEOUL_TDATA_API_KEY }}
          BASE: "https://t-data.seoul.go.kr/apig/apiman-gateway/tapi/v2xBusStationCrowdedInformation/1.0"
        run: |
          set -e
          echo "::add-mask::$API_KEY"
          mkdir -p data/seoul-bus-crowd
          export TZ=Asia/Seoul
          ts="$(date +'%Y%m%d-%H%M%S')"
          out="data/seoul-bus-crowd/${ts}.json"

          url="${BASE}?apikey=${API_KEY}&type=json&pageNo=1&numOfRows=100"
          echo "::add-mask::${url}"

          # 호출 → cameraId 일치 항목만 필터 → 파일 저장
          curl -sS -L "$url" \
          | jq --arg cam "$CAMERA_ID" '
              [ .[] | select((.cameraId // "") == $cam) ]
            ' > "$out"

          # 매칭 0건이면 커밋 생략
          if jq -e 'length == 0' "$out" >/dev/null 2>&1; then
            echo "No items matched cameraId=$CAMERA_ID. Skipping commit."
            rm -f "$out"
            exit 0
          fi

      - name: Commit & push
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add data/seoul-bus-crowd/*.json
          git commit -m "chore(data): save V2X JSON filtered by cameraId=${{ env.CAMERA_ID }} [skip ci]" || exit 0
          git push
