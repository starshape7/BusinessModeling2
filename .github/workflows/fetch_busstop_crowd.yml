# .github/workflows/fetch-seoul-bus-crowd.yml
name: Fetch Seoul V2X Bus Station Crowd JSON

on:
  schedule:
    # KST 08:00–08:59 → UTC 23:00–23:59 (전날)
    - cron: "*/5 23 * * *"
    # KST 09:00–20:59 → UTC 00:00–11:59 (당일)
    - cron: "*/5 0-11 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: fetch-seoul-bus-crowd
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      CAMERA_ID: "DLD1120013000"  # ← 원하는 cameraId로
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # (안전)

      - name: Fetch & filter by cameraId, then save
        id: fetch
        env:
          API_KEY: ${{ secrets.SEOUL_TDATA_API_KEY }}
          BASE: "https://t-data.seoul.go.kr/apig/apiman-gateway/tapi/v2xBusStationCrowdedInformation/1.0"
        run: |
          set -euo pipefail
          echo "::add-mask::$API_KEY"
          mkdir -p data/seoul-bus-crowd
          export TZ=Asia/Seoul
          ts="$(date +'%Y%m%d-%H%M%S')"
          out="data/seoul-bus-crowd/${ts}.json"

          url="${BASE}?apikey=${API_KEY}&type=json&pageNo=1&numOfRows=100"
          echo "Requesting: ${BASE}?apikey=***&type=json&pageNo=1&numOfRows=100"

          # 원본 응답도 보관해 디버깅 가능하게 (마스크됨)
          raw="data/seoul-bus-crowd/${ts}.raw.json"
          curl -sS -L "$url" -H "Accept: application/json" -o "$raw"

          # cameraId를 재귀적으로 찾아 필터링
          jq --arg cam "$CAMERA_ID" '
            [ .. | objects | select(has("cameraId")) | select(.cameraId == $cam) ]
          ' "$raw" > "$out"

          count="$(jq -r 'length' "$out")"
          echo "matched_count=$count" >> "$GITHUB_OUTPUT"

          if [ "$count" -eq 0 ]; then
            echo "No items matched cameraId=$CAMERA_ID. Keeping raw for debug, removing filtered file."
            rm -f "$out"
          else
            echo "Matched $count items → $out"
          fi

      - name: Commit & push
        if: steps.fetch.outputs.matched_count != '0'
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # 변경 사항이 있을 때만 커밋
          if [ -n "$(git status --porcelain)" ]; then
            git add data/seoul-bus-crowd/*.json
            git commit -m "chore(data): save V2X JSON (cameraId=${{ env.CAMERA_ID }}) [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi
